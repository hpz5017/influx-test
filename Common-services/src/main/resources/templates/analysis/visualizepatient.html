<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8" />
    <meta
            name="viewport"
            content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />
    <title>Brain Flux</title>
    <!-- Vendor styles -->
<link rel="stylesheet" href="/vendors/bower_components/material-design-iconic-font/dist/css/material-design-iconic-font.min.css">
<link rel="stylesheet" href="/vendors/bower_components/animate.css/animate.min.css">
<link rel="stylesheet" href="/vendors/bower_components/jquery.scrollbar/jquery.scrollbar.css">
<link rel="stylesheet" href="/vendors/bower_components/select2/dist/css/select2.min.css">
<link rel="stylesheet" href="/vendors/flatpickr/flatpickr.min.css" />
<link rel="stylesheet" href="/vendors/bower_components/dropzone/dist/dropzone.css">
<link rel="stylesheet" href="/vendors/bower_components/nouislider/distribute/nouislider.min.css">
<link rel="stylesheet" href="/vendors/bower_components/bootstrap-colorpicker/dist/css/bootstrap-colorpicker.css">
<link rel="stylesheet" href="/vendors/bower_components/trumbowyg/dist/ui/trumbowyg.min.css">
<link rel="icon" type="image/ico" href="/img/favicon.ico">


    <!-- App styles -->
    <link rel="stylesheet" href="/css/app.min.css" />

	<!-- visualize patient tools -->
	<style>
        .hidden {
            display: none;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/lodash@4.17.15/lodash.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vue"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts@4.5.0/dist/echarts.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.19.0/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts-gl@1.1.1/dist/echarts-gl.min.js"></script>

</head>

<body data-ma-theme="blue">
<main class="main">
    <div th:insert="fragments/page-loader :: div"></div>
    <div th:insert="fragments/header :: header"></div>
    <div th:insert="fragments/sidebar :: aside"></div>

    <section class="content">
        <div class="content__inner">
            <!-- PUT THE MAIN CONTENT HERE -->
            <header class="content__title">
                <h1>Data Visualization Chart</h1>
            </header>
            <div class="card" style="margin: 15px;">
                <div class="card-body">
                    <h3 class="card-title">Data selection</h3>
                    <div class="col-sm-12 col-md-12">
                        <div
                                id="app"
                                style="display: flex; flex-direction: column; align-items: center;"
                        >
                            <div style="display: flex; flex-direction: column;">
                                <div>Select min/max/mean data to visualize</div>
                                <div
                                        style="display: flex; flex-wrap: wrap; width: 400px; justify-content: space-between;"
                                >
                                    <div>
                                        <input
                                                type="radio"
                                                id="min"
                                                value="min"
                                                v-model="minMaxMean"
                                        />
                                        <label for="min">min</label>
                                    </div>
                                    <div>
                                        <input
                                                type="radio"
                                                id="max"
                                                value="max"
                                                v-model="minMaxMean"
                                        />
                                        <label for="max">max</label>
                                    </div>
                                    <div>
                                        <input
                                                type="radio"
                                                id="mean"
                                                value="mean"
                                                v-model="minMaxMean"
                                        />
                                        <label for="mean">mean</label>
                                    </div>
                                </div>
                                <div>Select 2 Attributes of Patients to Visualize</div>
                                <div
                                        style="display: flex; flex-wrap: wrap; width: 100%; justify-content: space-between;"
                                >
                                    <div
                                            class="custom-control custom-checkbox custom-control-inline"
                                            v-for="att in attributes"
                                            :key="att"
                                            style="flex-basis: 30%; margin: 5px 0;"
                                            v-if="!att.includes('!')"
                                    >
                                        <input
                                                class="custom-control-input"
                                                type="checkbox"
                                                :id="att"
                                                :value="att"
                                                v-model="selected"
                                                :disabled="selected.length >= 2 && !selected.includes(att)"
                                        />
                                        <label class="custom-control-label" :for="att"
                                        >{{att}}</label
                                        >
                                    </div>
                                </div>
                                <br />

                                <div style="color: #f44336;" v-if="selected.length !== 2">
                                    You must select 2 attributes to visualize
                                </div>

                                <button
                                        type="button"
                                        class="btn btn-primary"
                                        :disabled="selected.length !== 2"
                                        v-on:click="loadData"
                                >
                                    Load Data
                                </button>
                            </div>

                            <div class="hidden">
                                {{ options }}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div
                    style="display: flex; flex-wrap: wrap; width: 100%; justify-content: space-around; padding: 20px;"
            >
                <div
                        id="chart1"
                        style="margin: 15px; width: 45%; max-width: 600px; height:600px;"
                ></div>
                <div
                        id="chart2"
                        style="margin: 15px; width: 45%; max-width: 600px; height:600px;"
                ></div>
            </div>
            <div th:insert="fragments/footer :: footer"></div>
        </div>
    </section>
</main>

<div th:insert="fragments/ie-warning :: div"></div>

<script>
    window.chart1 = echarts.init(document.getElementById("chart1"), "dark");
    window.chart2 = echarts.init(document.getElementById("chart2"), "dark");

    const attributes = [
        "!count",
        "!PID",
        "!Timestamp",
        "!Timebins",
        "Alpha sum",
        "Delta sum",
        "Theta sum",
        "Beta sum",
        "Suppression ratio",
        "aEEG median",
        "aEEG max",
        "aEEG 75th %ile",
        "Peak envelope",
        "aEEG max std dev",
        "aEEG median std dev",
        "aEEG 75th %ile std dev",
        "Max seizure prob",
        "Spike sum",
        "Hemispheric absolute assymetry",
        "Hemispheric relative assymetry",
        "Anterior alpha assymetry",
        "Suppression ratio std dev",
        "Alpha standard dev",
        "Theta std dev",
        "aEEG max 75th %ile"
    ];

    const getAttriId = attr => {
        return attributes.indexOf(attr);
    };
    // register component to use

    const app = new Vue({
        el: "#app",
        data() {
            return {
                showOtions: false,
                data: [],
                raw: "",
                groupedData: {},
                minMaxMean: "mean",
                attributes,
                selected: []
            };
        },
        methods: {
            loadData: async function() {
                console.log(this.selected);
                if (this.selected.length === 2) {
                    const attributesSelected = this.selected
                        .map(s => getAttriId(s))
                .join(",");
                    const survivalRes = await axios.get("/apis/patients/allSurvival");
                    const survival = survivalRes.data;

                    const dataRes = await axios.get(
                        `/apis/data/patients/${attributesSelected}`
                    );                                      // read the 2 selected data
                    const rows = dataRes.data.data;
                    console.log(rows);
                    const convertedToNumbers = rows.map(row =>
                        row.map((item, id) => (id > 0 ? Number(item) : item))
                );
                    const withSurvival = convertedToNumbers.map(row => {
                        let status = "Unknown";
                    if (survival[row[0]] === 1) {
                        status = "Alive";
                    } else if (survival[row[0]] === 0) {
                        status = "Deceased";
                    }
                    return [...row, status];
                });
                    const grouped = _.groupBy(withSurvival, 0);
                    this.groupedData = grouped;
                }
            }
        },
        computed: {
            options() {
                let processedData = [];
                const entries = Object.entries(this.groupedData);
                // const entries = Object.entries(groupedData);
                window.entries = entries;
                processedData = entries.map(patientGroup => {
                    let pid = patientGroup[0];
                let stats = patientGroup[1];
                const statsFiltered = stats.filter(item => !item.includes(NaN));
                const status = statsFiltered[0][3];
                let stat1;
                let stat2;

                if (this.minMaxMean === "min") {
                    stat1 = _.minBy(statsFiltered, 1)[1];
                    stat2 = _.minBy(statsFiltered, 2)[2];
                } else if (this.minMaxMean === "max") {
                    stat1 = _.maxBy(statsFiltered, 1)[1];
                    stat2 = _.maxBy(statsFiltered, 2)[2];
                } else {
                    stat1 = _.meanBy(statsFiltered, 1);
                    stat2 = _.meanBy(statsFiltered, 2);
                }

                return [pid, stat1, stat2, status];
            });

                console.log(processedData);

                const updated = {
                    tooltip: {},
                    grid3D: {
                        axisLine: {
                            lineStyle: {
                                color: "#fff"
                            }
                        },
                        axisPointer: {
                            lineStyle: {
                                color: "#fff"
                            }
                        },
                        viewControl: {
                            // autoRotate: true
                        },
                        light: {
                            main: {
                                shadow: true,
                                quality: "ultra",
                                intensity: 1.5
                            }
                        }
                    },
                    xAxis3D: {
                        type: "category"
                    },
                    yAxis3D: {
                        name: this.selected[0] || 'Y',
                        type: "value"
                    },
                    zAxis3D: {
                        name: this.selected[1] || 'Z',
                        type: "value"
                    },
                    series: [
                        {
                            type: "bar3D",
                            // symbolSize: 2.5,
                            shading: "lambert",
                            data: processedData.map(row => {
                                return {
                                    value: [row[3], row[1], row[2]],
                                    itemStyle: {
                                        color:
                                            row[3] === "Deceased"
                                                ? "#d73027"
                                                : row[3] === "Alive"
                                                ? "#74add1"
                                                : "White"
                                    }
                                };
            }),
                label: {
                    show: false,
                        textStyle: {
                        fontSize: 16,
                            borderWidth: 1
                    }
                },

                itemStyle: {
                    opacity: 0.7
                },

                emphasis: {
                    label: {
                        textStyle: {
                            fontSize: 30,
                                color: "#900"
                        }
                    },
                    itemStyle: {
                        color: "#900"
                    }
                }
                // encode: {
                //   x: "this.attri1",
                //   y: "this.attri2",
                //   z: "this.attri3"
                // }
            }
            ]
            };
                const chart2Options = {
                    tooltip: {},
                    grid3D: {
                        axisLine: {
                            lineStyle: {
                                color: "#fff"
                            }
                        },
                        axisPointer: {
                            lineStyle: {
                                color: "#fff"
                            }
                        },
                        viewControl: {
                            // autoRotate: true
                        },
                        light: {
                            main: {
                                shadow: true,
                                quality: "ultra",
                                intensity: 1.5
                            }
                        }
                    },
                    xAxis3D: {
                        type: "category"
                    },
                    yAxis3D: {
                        name: this.selected[0] || 'Y',
                        type: "value"
                    },
                    zAxis3D: {
                        name: this.selected[1] || 'Z',
                        type: "value"
                    },
                    series: [
                        {
                            type: "scatter3D",
                            // symbolSize: 2.5,
                            shading: "lambert",
                            data: processedData.map(row => {
                                return {
                                    value: [row[0], row[1], row[2]],
                                    itemStyle: {
                                        color:
                                            row[3] === "Deceased"
                                                ? "#d73027"
                                                : row[3] === "Alive"
                                                ? "#74add1"
                                                : "White"
                                    }
                                };
            }),
                label: {
                    show: false,
                        textStyle: {
                        fontSize: 16,
                            borderWidth: 1
                    }
                },

                itemStyle: {
                    opacity: 0.7
                },

                emphasis: {
                    label: {
                        textStyle: {
                            fontSize: 30,
                                color: "#900"
                        }
                    },
                    itemStyle: {
                        color: "#900"
                    }
                }
                // encode: {
                //   x: "this.attri1",
                //   y: "this.attri2",
                //   z: "this.attri3"
                // }
            }
            ]
            };
                window.chart1.setOption(updated);
                window.chart2.setOption(chart2Options);
                return updated;
            }
        }
    });
    window.chart1.on("click", params => {
        const pid = params.value[3];
    window.open(`/analysis/medInfo/${pid}`);
    });
    window.chart2.on("click", params => {
        const pid = params.value[0];
    window.open(`/analysis/medInfo/${pid}`);
    });

</script>
<!-- Javascript -->

<!-- Javascript -->
<script th:inline="javascript">
    /*<![CDATA[*/
    var columns = /*[[${columns}]]*/ null;
    /*]]>*/
</script>
<!-- Vendors -->
<script src="/vendors/bower_components/jquery/dist/jquery.min.js"></script>
<script src="/vendors/bower_components/tether/dist/js/tether.min.js"></script>
<script src="/vendors/bower_components/popper.js/dist/umd/popper.min.js"></script>
<script src="/vendors/bower_components/bootstrap/dist/js/bootstrap.min.js"></script>
<script src="/vendors/bower_components/jquery.scrollbar/jquery.scrollbar.min.js"></script>
<script src="/vendors/bower_components/jquery-scrollLock/jquery-scrollLock.min.js"></script>

<script src="/vendors/bower_components/jquery-mask-plugin/dist/jquery.mask.min.js"></script>
<script src="/vendors/bower_components/select2/dist/js/select2.full.min.js"></script>
<script src="/vendors/bower_components/dropzone/dist/min/dropzone.min.js"></script>
<script src="/vendors/bower_components/moment/min/moment.min.js"></script>
<script src="/vendors/flatpickr/flatpickr.min.js"></script>
<script src="/vendors/bower_components/nouislider/distribute/nouislider.min.js"></script>
<script src="/vendors/bower_components/bootstrap-colorpicker/dist/js/bootstrap-colorpicker.min.js"></script>
<script src="/vendors/bower_components/trumbowyg/dist/trumbowyg.min.js"></script>

<script src="/vendors/bower_components/remarkable-bootstrap-notify/dist/bootstrap-notify.min.js"></script>

<!-- Vendors: Data tables -->
<script src="/vendors/bower_components/datatables.net/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/plug-ins/1.10.19/dataRender/datetime.js"></script>
<script src="/vendors/bower_components/datatables.net-buttons/js/dataTables.buttons.min.js"></script>
<script src="/vendors/bower_components/datatables.net-buttons/js/buttons.print.min.js"></script>
<script src="/vendors/bower_components/jszip/dist/jszip.min.js"></script>
<script src="/vendors/bower_components/datatables.net-buttons/js/buttons.html5.min.js"></script>
<script src="/vendors/bower_components/datatables.net/js/moment.min.js"></script>
<script src="/vendors/bower_components/datatables.net/js/datetime-moment.js"></script>

<!-- App functions and actions -->
<script src="/js/navigation.js"></script>
<script src="/js/app.min.js"></script>
<script src="/js/analysis/chart.js"></script>
<script src="/js/analysis/visualizepatient.js"></script>

<!-- TimeLine graph setting -->
<script src="/js/analysis/TimeLineGraph.min.js"></script>
</body>
</html>
